<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>bitvid Content Appeals Form</title>
    <style>
      /* Basic styling for the form and log output */
      body {
        background: #222;
        color: #eee;
        font-family: sans-serif;
        margin: 20px;
        max-width: 800px;
      }
      h1,
      h2 {
        color: #66ff66;
      }
      label {
        display: block;
        margin-top: 1em;
        font-weight: bold;
      }
      input,
      textarea,
      select {
        width: 100%;
        margin-bottom: 0.75em;
        background: #333;
        color: #fff;
        border: 1px solid #888;
        padding: 0.5em;
        box-sizing: border-box;
      }
      button {
        padding: 0.5em 1em;
        background: #3399cc;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #status {
        margin-top: 1em;
        padding: 0.5em;
        background: #111;
        white-space: pre-wrap;
        min-height: 80px;
      }
      .status-line {
        margin: 0.25em 0;
      }
      .error {
        color: #ff6666;
      }
      .success {
        color: #66ff66;
      }
      .warn {
        color: #ffff66;
      }
    </style>

    <!--
      bitvid Content Appeals Form
      
      Key Points and Lessons Learned:
      
      1. We use nostr‑tools v2.10.4 to send a Nostr event that contains the appeal data.
         - The target npub is decoded (using nip19.decode) to extract the target public key.
         - An ephemeral key pair is generated with generateSecretKey (returns a Uint8Array) and getPublicKey (returns a hex string).
      2. The form collects detailed appeal information (user info, content details, reasons, additional context, and declaration).
      3. On submission, all form field values are assembled into a Markdown‑formatted message.
      4. The message is encrypted using nip04.encrypt with the ephemeral private key and the target public key.
      5. The event template (kind 4) is built with the encrypted message and then finalized via finalizeEvent,
         which automatically computes event.id, assigns the ephemeral pubkey, and signs the event.
      6. The event is published to multiple relays using SimplePool.publish (which now returns a promise), and we use Promise.any
         to wait for at least one relay to accept the event.
      7. For subscriptions, we use the Relay API (Relay.connect and relay.subscribe) to verify that the event appears in storage.
      
      This implementation leverages the higher‑level APIs provided by nostr‑tools to simplify event creation,
      signing, and relay interaction while providing detailed logging for debugging purposes.
    -->

    <!-- Load nostr‑tools v2.10.4 -->
    <script src="https://cdn.jsdelivr.net/npm/nostr-tools@2.10.4/lib/nostr.bundle.min.js"></script>
  </head>
  <body>
    <h1>bitvid Content Appeals Form</h1>
    <p>
      If you believe your content was unfairly blocked or restricted on bitvid,
      please complete this form. Appeals will be reviewed manually, and
      decisions will be communicated back to you.
    </p>

    <form id="dm-form">
      <h2>1. User Information</h2>
      <label for="npubInput">Nostr Public Key (npub):</label>
      <input
        type="text"
        id="npubInput"
        placeholder="Enter your npub"
        required
      />

      <label for="contactMethod">Contact Method (if applicable):</label>
      <input
        type="text"
        id="contactMethod"
        placeholder="Nostr DM, email, or other"
      />

      <h2>2. Content Details</h2>
      <label for="videoTitle">Title of the Video:</label>
      <input type="text" id="videoTitle" placeholder="Enter the exact title" />

      <label for="magnetLink">Magnet Link:</label>
      <input type="text" id="magnetLink" placeholder="Enter the magnet link" />

      <label for="submissionDate">Date of Content Submission:</label>
      <input type="date" id="submissionDate" />

      <h2>3. Reason for Appeal</h2>
      <label for="reasonBlocked"
        >Why do you believe your content was unfairly blocked?</label
      >
      <textarea
        id="reasonBlocked"
        rows="3"
        placeholder="Explain in detail"
      ></textarea>

      <label for="fitsGuidelines"
        >Does your content fit within bitvid's Community Guidelines?</label
      >
      <select id="fitsGuidelines">
        <option value="">Select an option</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>

      <label for="guidelinesCited"
        >If yes, which guideline(s) support your appeal?</label
      >
      <textarea
        id="guidelinesCited"
        rows="2"
        placeholder="Cite the specific guidelines"
      ></textarea>

      <label for="editedContent"
        >Was this content edited after being blocked?</label
      >
      <select id="editedContent">
        <option value="">Select an option</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>

      <label for="changesMade">If yes, what changes were made?</label>
      <textarea
        id="changesMade"
        rows="2"
        placeholder="Describe the modifications"
      ></textarea>

      <h2>4. Additional Context</h2>
      <label for="misunderstanding"
        >Was there any misunderstanding or misclassification?</label
      >
      <textarea
        id="misunderstanding"
        rows="2"
        placeholder="Provide context"
      ></textarea>

      <label for="externalReferences"
        >Are there external references that validate your appeal?</label
      >
      <textarea
        id="externalReferences"
        rows="2"
        placeholder="Links, citations, or additional info"
      ></textarea>

      <h2>5. Declaration</h2>
      <p>
        By submitting this appeal, you confirm that:
        <br />- You are the original creator or authorized representative of the
        content. <br />- Your appeal is submitted in good faith and aligns with
        bitvid’s policies. <br />- You understand that final decisions are at
        the discretion of bitvid’s moderation process.
      </p>
      <label for="signature">Signature (Digital or Written):</label>
      <input type="text" id="signature" placeholder="Your signature" />

      <label for="declarationDate">Date:</label>
      <input type="date" id="declarationDate" />

      <button type="submit">Submit Appeal</button>
    </form>

    <div id="status"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Logging functions for both on-page and console output.
        function log(msg, type = "info") {
          const div = document.createElement("div");
          div.classList.add("status-line");
          if (type === "error") div.classList.add("error");
          if (type === "success") div.classList.add("success");
          if (type === "warn") div.classList.add("warn");
          div.textContent = msg;
          document.getElementById("status").appendChild(div);
          console.log(`[${type.toUpperCase()}] ${msg}`);
        }
        function clear() {
          document.getElementById("status").innerHTML = "";
        }

        if (!window.NostrTools) {
          log("NostrTools not loaded. Check console or ad-blockers.", "error");
          return;
        }

        // Destructure the required functions and classes from nostr-tools.
        // finalizeEvent automatically assigns the pubkey, computes event.id, and signs the event.
        const {
          generateSecretKey,
          getPublicKey,
          finalizeEvent,
          nip04,
          nip19,
          SimplePool,
          utils,
          Relay, // Relay API for subscriptions.
        } = window.NostrTools;

        // Define relay URLs.
        const RELAYS = [
          "wss://relay.snort.social",
          "wss://relay.damus.io",
          "wss://relay.primal.net",
        ];

        // Create a SimplePool instance for publishing events.
        const pool = new SimplePool();

        // Main form submission handler.
        document
          .getElementById("dm-form")
          .addEventListener("submit", async (ev) => {
            ev.preventDefault();
            clear();

            try {
              // 1) Retrieve user input from all fields.
              const npub = document.getElementById("npubInput").value.trim();
              if (!npub.startsWith("npub")) {
                throw new Error("Target must start with npub.");
              }
              const contactMethod = document
                .getElementById("contactMethod")
                .value.trim();
              const videoTitle = document
                .getElementById("videoTitle")
                .value.trim();
              const magnetLink = document
                .getElementById("magnetLink")
                .value.trim();
              const submissionDate = document
                .getElementById("submissionDate")
                .value.trim();
              const reasonBlocked = document
                .getElementById("reasonBlocked")
                .value.trim();
              const fitsGuidelines = document
                .getElementById("fitsGuidelines")
                .value.trim();
              const guidelinesCited = document
                .getElementById("guidelinesCited")
                .value.trim();
              const editedContent = document
                .getElementById("editedContent")
                .value.trim();
              const changesMade = document
                .getElementById("changesMade")
                .value.trim();
              const misunderstanding = document
                .getElementById("misunderstanding")
                .value.trim();
              const externalReferences = document
                .getElementById("externalReferences")
                .value.trim();
              const signature = document
                .getElementById("signature")
                .value.trim();
              const declarationDate = document
                .getElementById("declarationDate")
                .value.trim();

              // 2) Construct the appeal content as a Markdown formatted string.
              const appealContent = `
# **bitvid Content Appeals Form**

**1. User Information**
- **Nostr Public Key (npub):** ${npub}
- **Contact Method:** ${contactMethod || "N/A"}

**2. Content Details**
- **Title of the Video:** ${videoTitle}
- **Magnet Link:** ${magnetLink}
- **Date of Content Submission:** ${submissionDate}

**3. Reason for Appeal**
- **Why do you believe your content was unfairly blocked?**  
  ${reasonBlocked}
- **Does your content fit within bitvid's Community Guidelines?**  
  ${fitsGuidelines}
- **If yes, which guideline(s) support your appeal?**  
  ${guidelinesCited}
- **Was this content edited after being blocked?**  
  ${editedContent}
- **If yes, what changes were made?**  
  ${changesMade}

**4. Additional Context**
- **Was there any misunderstanding or misclassification?**  
  ${misunderstanding}
- **Are there external references that validate your appeal?**  
  ${externalReferences}

**5. Declaration**
By submitting this appeal, you confirm that:
- You are the original creator or an authorized representative of the content.
- Your appeal is submitted in good faith and aligns with bitvid’s policies.
- You understand that final decisions are at the discretion of bitvid’s moderation process.

**Signature (Digital or Written):** ${signature}
**Date:** ${declarationDate}

---

**Processing Time:** Appeals will be reviewed within **7-14 days**. If additional information is required, you will be contacted via your provided contact method.

For further questions, reach out through bitvid’s Nostr support channels.
            `.trim();

              log("[DEBUG] Constructed appeal content:\n" + appealContent);

              // 3) Decode the target npub to get the target public key.
              log("Decoding target npub...");
              const decoded = nip19.decode(npub);
              log("[DEBUG] Decoded npub: " + JSON.stringify(decoded));
              if (decoded.type !== "npub") {
                throw new Error("Decoded type is not npub.");
              }
              const targetPubHex = decoded.data;
              log("Target pubkey: " + targetPubHex.slice(0, 16) + "...");

              // 4) Generate an ephemeral key pair.
              log("Generating ephemeral key...");
              const ephemeralPriv = generateSecretKey(); // returns a Uint8Array
              const ephemeralPubHex = getPublicKey(ephemeralPriv); // returns a hex string
              log("Ephemeral pubkey: " + ephemeralPubHex.slice(0, 16) + "...");

              // 5) Encrypt the appeal content using NIP‑04.
              log("Encrypting appeal content (nip04)...");
              const ciphertext = await nip04.encrypt(
                ephemeralPriv,
                targetPubHex,
                appealContent
              );
              log("[DEBUG] Ciphertext: " + ciphertext);
              log("Encryption done.");

              // 6) Build the Nostr event template (kind 4 for DMs) with the encrypted appeal.
              const now = Math.floor(Date.now() / 1000);
              const eventTemplate = {
                kind: 4,
                created_at: now,
                tags: [["p", targetPubHex]],
                content: ciphertext,
              };
              log(
                "[DEBUG] Event template before finalizing: " +
                  JSON.stringify(eventTemplate)
              );

              // 7) Finalize the event: compute event.id, sign it, and assign the pubkey.
              const event = finalizeEvent(eventTemplate, ephemeralPriv);
              log("[DEBUG] Final event: " + JSON.stringify(event));

              // 8) Publish the event to all relays.
              log("Publishing the appeal to relays...");
              await Promise.any(pool.publish(RELAYS, event));
              log("At least one relay accepted the event.", "success");

              // 9) For each relay, subscribe using the Relay API to verify that the event appears.
              for (const url of RELAYS) {
                log("Connecting to " + url + " for subscription...");
                const relay = await Relay.connect(url);
                relay.subscribe([{ authors: [ephemeralPubHex], kinds: [4] }], {
                  onEvent(foundEvent) {
                    if (foundEvent.id === event.id) {
                      log(
                        "[" +
                          url +
                          "] => Found our appeal in storage! ID: " +
                          foundEvent.id.slice(0, 8) +
                          "...",
                        "success"
                      );
                    }
                  },
                  onEose() {
                    relay.close();
                  },
                });
              }

              log(
                "Done. If the logs show 'Relay accepted' and 'Found our appeal in storage', the appeal was successfully published. A moderator will review your appeal within 7-14 days."
              );
            } catch (err) {
              log("Error: " + err.message, "error");
              console.error(err);
            }
          });
      });
    </script>
  </body>
</html>
