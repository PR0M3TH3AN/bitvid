<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Content Appeals Form</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        max-width: 600px;
        /* Make the background transparent so it shows page behind */
        background: transparent;
        /* Keep text white */
        color: #fff;
      }
      label {
        display: inline-block;
        margin: 8px 0 4px 0;
        font-weight: bold;
        color: #fff;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 6px;
        margin-bottom: 16px;
        box-sizing: border-box;
        background-color: #234566; /* dark blue background */
        color: #fff; /* white text */
        border: 1px solid #888;
      }
      button {
        padding: 10px 16px;
        cursor: pointer;
      }
      h1,
      h2,
      h3 {
        margin-top: 24px;
        color: #fff;
      }
      p {
        color: #fff;
      }
      /* Status area styling */
      #status-message {
        white-space: pre; /* Preserves line breaks when we append text */
        margin-top: 1em;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <form id="appeal-form">
      <h3>1. User Information</h3>
      <label for="npub">Nostr Public Key (npub)</label>
      <input
        type="text"
        id="npub"
        name="npub"
        placeholder="Your npub"
        required
      />

      <label for="contactMethod">Contact Method (if applicable)</label>
      <input
        type="text"
        id="contactMethod"
        name="contactMethod"
        placeholder="Nostr DM, email, etc."
      />

      <h3>2. Content Details</h3>
      <label for="videoTitle">Title of the Video</label>
      <input
        type="text"
        id="videoTitle"
        name="videoTitle"
        placeholder="Exact video title"
        required
      />

      <label for="magnetLink">Magnet Link</label>
      <input
        type="text"
        id="magnetLink"
        name="magnetLink"
        placeholder="Magnet link for the video"
        required
      />

      <label for="submissionDate"
        >Date of Content Submission (MM/DD/YYYY)</label
      >
      <input
        type="text"
        id="submissionDate"
        name="submissionDate"
        placeholder="MM/DD/YYYY"
        required
      />

      <h3>3. Reason for Appeal</h3>
      <label for="whyUnfair"
        >Why do you believe your content was unfairly blocked?</label
      >
      <textarea id="whyUnfair" name="whyUnfair" rows="4" required></textarea>

      <label for="guidelinesFit"
        >Does your content fit within bitvid's Community Guidelines?
        (Yes/No)</label
      >
      <input
        type="text"
        id="guidelinesFit"
        name="guidelinesFit"
        placeholder="Yes or No"
        required
      />

      <label for="whichGuidelines"
        >If yes, which guideline(s) support your appeal?</label
      >
      <textarea id="whichGuidelines" name="whichGuidelines" rows="3"></textarea>

      <label for="contentEdited"
        >Was this content edited after being blocked? (Yes/No)</label
      >
      <input
        type="text"
        id="contentEdited"
        name="contentEdited"
        placeholder="Yes or No"
        required
      />

      <label for="changesMade">If yes, what changes were made?</label>
      <textarea id="changesMade" name="changesMade" rows="3"></textarea>

      <h3>4. Additional Context</h3>
      <label for="misunderstanding"
        >Was there any misunderstanding or misclassification?</label
      >
      <textarea
        id="misunderstanding"
        name="misunderstanding"
        rows="3"
      ></textarea>

      <label for="externalRefs"
        >Are there external references that validate your appeal?</label
      >
      <textarea id="externalRefs" name="externalRefs" rows="3"></textarea>

      <h3>5. Declaration</h3>
      <p>
        By submitting this appeal, you confirm that:<br />
        - You are the original creator or authorized representative of the
        content in question.<br />
        - Your appeal is submitted in good faith and aligns with bitvid’s
        policies.<br />
        - You understand that final decisions are at the discretion of bitvid’s
        moderation process.
      </p>
      <label for="signature">Signature (Digital or Written)</label>
      <input type="text" id="signature" name="signature" required />

      <label for="dateSigned">Date (MM/DD/YYYY)</label>
      <input
        type="text"
        id="dateSigned"
        name="dateSigned"
        placeholder="MM/DD/YYYY"
        required
      />

      <button type="submit">Submit Appeal</button>
    </form>

    <p>
      <strong>Processing Time:</strong> Appeals will be reviewed within 7-14
      days.
    </p>
    <hr />

    <!-- Area to display status feedback -->
    <div id="status-message"></div>

    <script type="module">
      // Using esm.sh for a pinned version (1.14.4).
      // This version should include all required methods (generatePrivateKey, etc.).
      import {
        generatePrivateKey,
        getPublicKey,
        nip19,
        getEventHash,
        signEvent,
        nip04,
        relayInit,
      } from "https://esm.sh/nostr-tools@1.14.4";

      // ---- Configure target npubs and relays here ----
      const targetNpubs = [
        // Add the npubs that should receive the DMs.
        // Example:
        "npub13yarr7j6vjqjjkahd63dmr27curypehx45ucue286ac7sft27y0srnpmpe",
        // "npub1ANOTHER_TARGET",
      ];

      const relays = {
        "wss://relay.snort.social": true,
        "wss://relay.damus.io": true,
        "wss://relay.primal.net": true,
      };
      // -----------------------------------------------

      const form = document.getElementById("appeal-form");
      const statusEl = document.getElementById("status-message");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.textContent = ""; // Clear old status messages

        // Collect form data
        const formData = new FormData(form);
        const dataObject = {};
        formData.forEach((value, key) => {
          dataObject[key] = value.trim();
        });

        // Generate ephemeral key pair
        let ephemeralPrivKey;
        let ephemeralPubKeyHex;
        try {
          ephemeralPrivKey = generatePrivateKey();
          ephemeralPubKeyHex = getPublicKey(ephemeralPrivKey);
        } catch (err) {
          statusEl.textContent = "Error generating ephemeral key: " + err;
          return;
        }

        // Convert form data to JSON
        const formText = JSON.stringify(dataObject, null, 2);

        // For each target recipient:
        let overallSuccess = false; // Track if any relay publishes succeed
        for (const npub of targetNpubs) {
          try {
            const decoded = nip19.decode(npub);
            if (decoded.type !== "npub") {
              const msg = `Skipping invalid npub: ${npub}`;
              console.error(msg);
              statusEl.textContent += msg + "\n";
              continue;
            }
            const targetPubKeyHex = decoded.data;

            // Encrypt using NIP-04
            let ciphertext;
            try {
              ciphertext = await nip04.encrypt(
                ephemeralPrivKey,
                targetPubKeyHex,
                formText
              );
            } catch (encErr) {
              const msg = `Failed to encrypt for ${npub}: ${encErr}`;
              console.error(msg);
              statusEl.textContent += msg + "\n";
              continue;
            }

            // Build event
            const now = Math.floor(Date.now() / 1000);
            const eventToSend = {
              kind: 4, // NIP-04 (Encrypted Direct Message)
              pubkey: ephemeralPubKeyHex,
              created_at: now,
              tags: [["p", targetPubKeyHex]],
              content: ciphertext,
            };

            // Sign event
            try {
              eventToSend.id = getEventHash(eventToSend);
              eventToSend.sig = signEvent(eventToSend, ephemeralPrivKey);
            } catch (signErr) {
              const msg = `Failed to sign event for ${npub}: ${signErr}`;
              console.error(msg);
              statusEl.textContent += msg + "\n";
              continue;
            }

            // Publish event to each relay
            for (const relayUrl of Object.keys(relays)) {
              const relay = relayInit(relayUrl);
              relay.on("connect", () => {
                console.log(`Connected to ${relayUrl}`);
                statusEl.textContent += `Connected to ${relayUrl}\n`;
              });
              relay.on("error", () => {
                console.log(`Failed to connect to ${relayUrl}`);
                statusEl.textContent += `Failed to connect to ${relayUrl}\n`;
              });

              await relay.connect();

              const pub = relay.publish(eventToSend);
              pub.on("ok", () => {
                console.log(`Event published to ${relayUrl}`);
                statusEl.textContent += `Event published to ${relayUrl}\n`;
                overallSuccess = true;
              });
              pub.on("failed", (reason) => {
                console.error(`Failed to publish to ${relayUrl}:`, reason);
                statusEl.textContent += `Failed to publish to ${relayUrl}: ${reason}\n`;
              });

              // Close the relay after a short delay
              setTimeout(() => relay.close(), 3000);
            }
          } catch (err) {
            console.error("Error handling npub:", npub, err);
            statusEl.textContent += `Error handling npub ${npub}: ${err}\n`;
          }
        }

        // If at least one relay published successfully, we consider it a success
        if (overallSuccess) {
          alert(
            "Your appeal was submitted to at least one relay successfully."
          );
        } else {
          alert("Submission encountered errors. Check status messages above.");
        }

        // Optionally reset the form
        form.reset();
      });
    </script>
  </body>
</html>
